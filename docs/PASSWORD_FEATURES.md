# 密码功能增强说明

## 概述

Narratium 已成功增加了密码安全功能，包括注册时的二次密码确认和忘记密码功能。

## 新增功能

### 1. 注册二次密码确认

#### 功能描述
- 用户在注册时需要输入两次密码进行确认
- 系统会验证两次输入的密码是否一致
- 防止用户因输入错误而无法正常使用账户

#### 实现细节
- 在注册表单中增加"确认密码"字段
- 前端验证两次密码输入是否一致
- 后端接收密码后直接进行注册处理

#### 用户体验
- 清晰的错误提示："两次输入的密码不一致"
- 密码字段标签动态显示："密码" / "新密码"
- 占位符文本提供明确的操作指引

### 2. 忘记密码功能

#### 功能描述
- 用户可以通过邮箱验证码重置密码
- 支持已注册用户找回密码
- 安全的密码重置流程

#### 实现流程
1. **发起重置请求**
   - 用户点击"忘记密码？"链接
   - 输入注册邮箱地址
   - 系统验证邮箱是否已注册

2. **发送验证码**
   - 系统生成6位数字验证码
   - 通过邮件发送验证码
   - 验证码5分钟有效期

3. **重置密码**
   - 用户输入验证码和新密码
   - 系统验证验证码有效性
   - 更新用户密码并清除验证码

#### 安全措施
- 验证码一次性使用
- 5分钟自动过期
- 密码加密存储（bcryptjs）
- 邮箱存在性验证

## 技术实现

### 1. 后端API

#### 忘记密码API (`/api/auth/forgot-password`)
```typescript
// 发送重置密码验证码
POST /api/auth/forgot-password
{
  "email": "user@example.com",
  "action": "sendCode"
}

// 重置密码
POST /api/auth/forgot-password
{
  "email": "user@example.com",
  "code": "123456",
  "newPassword": "newpassword",
  "action": "resetPassword"
}
```

#### 邮件模板
- 专业的HTML邮件模板
- 符合Narratium主题色彩
- 清晰的验证码显示
- 安全提示信息

### 2. 前端组件

#### 认证上下文扩展
```typescript
interface AuthContextType {
  // ... 现有方法
  sendResetPasswordCode: (email: string) => Promise<{ success: boolean; message: string }>;
  resetPassword: (email: string, code: string, newPassword: string) => Promise<{ success: boolean; message: string }>;
}
```

#### 认证页面增强
- 动态表单字段显示
- 忘记密码模式切换
- 二次密码确认验证
- 友好的用户界面

### 3. 数据库操作

#### 密码更新
```typescript
// 使用现有的update方法更新密码
await userRepository.update(existingUser.id, { password: hashedPassword });
```

## 用户界面

### 1. 登录页面
- 新增"忘记密码？"链接
- 点击后切换到忘记密码模式
- 保持界面一致性

### 2. 注册页面
- 增加"确认密码"字段
- 实时密码一致性验证
- 清晰的错误提示

### 3. 忘记密码页面
- 专门的密码重置界面
- 步骤化的操作流程
- "返回登录"按钮

## 错误处理

### 1. 验证错误
- 邮箱格式验证
- 密码一致性检查
- 验证码有效性验证

### 2. 业务错误
- 邮箱未注册提示
- 验证码过期处理
- 邮件发送失败处理

### 3. 网络错误
- 请求超时处理
- 服务器错误提示
- 用户友好的错误信息

## 安全考虑

### 1. 密码安全
- bcryptjs加密存储
- 12轮加密强度
- 明文密码不存储

### 2. 验证码安全
- 6位随机数字
- 5分钟过期时间
- 一次性使用机制

### 3. 邮件安全
- Gmail应用专用密码
- 环境变量配置
- 邮件发送状态检查

## 配置要求

### 1. 环境变量
确保 `.env.local` 文件中包含邮件配置：
```env
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-password
```

### 2. 依赖包
系统使用现有的依赖包，无需额外安装：
- `nodemailer` - 邮件发送
- `bcryptjs` - 密码加密

## 使用流程

### 1. 用户注册
1. 访问 `/auth` 页面
2. 切换到"注册"标签
3. 输入邮箱地址
4. 发送验证码
5. 输入密码和确认密码
6. 输入验证码完成注册

### 2. 忘记密码
1. 在登录页面点击"忘记密码？"
2. 输入注册邮箱地址
3. 点击"发送验证码"
4. 检查邮箱并输入验证码
5. 输入新密码和确认密码
6. 点击"重置密码"完成重置

## 故障排除

### 1. 邮件发送问题
- 检查邮件配置是否正确
- 确认Gmail两步验证已启用
- 验证应用专用密码

### 2. 验证码问题
- 检查邮箱是否收到验证码
- 确认验证码在5分钟内使用
- 验证码输入是否正确

### 3. 密码重置问题
- 确认邮箱已注册
- 检查两次密码输入是否一致
- 验证验证码有效性

## 未来改进

### 1. 功能增强
- 密码强度检查
- 密码历史记录
- 多因素认证

### 2. 用户体验
- 密码强度指示器
- 更详细的错误提示
- 操作步骤指引

### 3. 安全增强
- 登录尝试限制
- 异常登录检测
- 安全日志记录 