# 邮箱认证系统实现说明

## 概述

Narratium 已成功升级为基于邮箱验证码的服务器端认证系统，替代了原有的本地存储登录方式。

## 系统架构

### 1. 前端组件

#### 认证上下文 (`contexts/AuthContext.tsx`)
- 管理用户认证状态
- 提供登录、注册、登出功能
- 处理本地存储同步

#### 认证页面 (`app/auth/page.tsx`)
- 统一的登录/注册界面
- 邮箱验证码发送功能
- 响应式设计，覆盖主界面

#### 认证守卫 (`components/AuthGuard.tsx`)
- 保护需要登录的页面
- 自动重定向未认证用户
- 加载状态处理

### 2. 后端API

#### 注册API (`app/api/auth/register/route.ts`)
- 邮箱验证码发送
- 用户注册处理
- 密码加密存储

#### 登录API (`app/api/auth/login/route.ts`)
- 用户登录验证
- 密码验证

### 3. 数据存储

#### 认证数据存储 (`lib/data/auth-store.ts`)
- 模拟数据库功能
- 用户数据管理
- 验证码存储和清理

## 功能特性

### 1. 邮箱验证码注册
- 发送6位数字验证码
- 5分钟有效期
- 防重复注册检查

### 2. 邮箱密码登录
- 安全的密码验证
- 自动登录状态管理

### 3. 界面覆盖
- 认证页面完全覆盖主界面
- 防止未认证用户访问功能
- 响应式设计支持

### 4. 状态管理
- 全局认证状态
- 本地存储同步
- 自动登录恢复

## 安全措施

### 1. 密码安全
- bcryptjs 加密存储
- 12轮加密强度
- 明文密码不存储

### 2. 验证码安全
- 6位随机数字
- 5分钟自动过期
- 一次性使用

### 3. 数据保护
- 环境变量配置
- 敏感信息隔离
- 定期数据清理

## 配置要求

### 1. 环境变量
```env
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-password
NEXT_PUBLIC_BASE_URL=http://localhost:3000
```

### 2. 依赖包
```json
{
  "nodemailer": "^6.9.0",
  "bcryptjs": "^2.4.3",
  "@types/nodemailer": "^6.4.0",
  "@types/bcryptjs": "^2.4.0"
}
```

## 使用流程

### 1. 用户注册
1. 访问 `/auth` 页面
2. 切换到"注册"标签
3. 输入邮箱地址
4. 点击"发送验证码"
5. 检查邮箱并输入验证码
6. 设置密码并完成注册

### 2. 用户登录
1. 访问 `/auth` 页面
2. 在"登录"标签下
3. 输入邮箱和密码
4. 点击登录按钮

### 3. 访问受保护页面
- 未认证用户自动重定向到 `/auth`
- 已认证用户正常访问功能
- 登出后清除所有认证状态

## 测试验证

### 1. 功能测试
- 访问 `/test-auth` 页面
- 验证认证状态显示
- 测试登出功能

### 2. 邮件测试
- 配置邮件服务
- 测试验证码发送
- 验证邮件模板

### 3. 安全测试
- 测试无效验证码
- 验证密码错误处理
- 检查重复注册防护

## 部署注意事项

### 1. 生产环境
- 使用真实数据库替代内存存储
- 配置专业邮件服务
- 启用 HTTPS
- 设置邮件发送限制

### 2. 性能优化
- 实现验证码发送频率限制
- 添加用户会话管理
- 优化邮件发送队列

### 3. 监控告警
- 邮件发送状态监控
- 用户注册登录统计
- 异常行为检测

## 故障排除

### 1. 邮件发送失败
- 检查环境变量配置
- 验证邮件服务设置
- 查看服务器日志

### 2. 认证状态异常
- 清除浏览器缓存
- 检查本地存储
- 重新登录

### 3. 页面访问问题
- 确认路由配置
- 检查组件导入
- 验证认证守卫

## 后续改进

### 1. 功能增强
- 添加密码重置功能
- 实现邮箱变更验证
- 支持第三方登录

### 2. 安全加固
- 实现 JWT 令牌
- 添加登录尝试限制
- 增强密码策略

### 3. 用户体验
- 优化加载动画
- 添加错误提示
- 改进响应式设计 