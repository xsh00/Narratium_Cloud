# 多邮箱池配置指南

## 概述

为了解决Gmail每日发送限制问题，Narratium现在支持多邮箱池发送机制。系统会自动轮换使用多个邮箱账户，当一个账户达到每日限制时，自动切换到下一个可用账户。

## 配置方式

### 1. 多邮箱配置（推荐）

在项目根目录的 `.env.local` 文件中配置多个邮箱账户：

```env
# 邮箱账户1
EMAIL_USER_1=your-email-1@gmail.com
EMAIL_PASS_1=your-app-password-1

# 邮箱账户2
EMAIL_USER_2=your-email-2@gmail.com
EMAIL_PASS_2=your-app-password-2

# 邮箱账户3
EMAIL_USER_3=your-email-3@gmail.com
EMAIL_PASS_3=your-app-password-3

# 可以继续添加更多账户...
```

### 2. 单邮箱配置（兼容模式）

如果只配置一个邮箱账户，系统会自动使用默认配置：

```env
# 默认邮箱配置
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-password
```

## Gmail 应用专用密码设置

### 为每个邮箱账户设置应用专用密码

1. **启用两步验证**
   - 登录每个Gmail账户
   - 访问 [Google 账户安全设置](https://myaccount.google.com/security)
   - 启用两步验证

2. **生成应用专用密码**
   - 在两步验证页面，找到"应用专用密码"
   - 点击"生成新的应用专用密码"
   - 选择应用类型：其他（自定义名称）
   - 输入名称：Narratium Cloud
   - 点击"生成"
   - 复制生成的16位密码

3. **配置环境变量**
   - 将每个邮箱和对应的应用专用密码填入 `.env.local` 文件
   - 确保密码格式正确（不包含空格）

## 系统特性

### 1. 自动轮换
- 系统会自动轮换使用可用账户
- 每个账户每日限制500封邮件
- 达到限制的账户会被自动标记为不可用

### 2. 智能管理
- 每日0点自动重置发送计数
- 实时监控每个账户的使用情况
- 自动处理发送失败和限制错误

### 3. 状态监控
- 提供邮箱池管理页面：`/admin/email-pool`
- 实时显示每个账户的使用状态
- 支持手动重置账户状态

## 管理界面

### 访问邮箱池管理页面

1. 启动开发服务器：`npm run dev`
2. 访问：`http://localhost:3000/admin/email-pool`
3. 查看邮箱池状态和管理功能

### 管理功能

- **状态查看**：显示所有邮箱账户的使用情况
- **统计信息**：总账户数、活跃账户数、可用率
- **重置功能**：手动重置所有账户的发送计数
- **实时监控**：使用率进度条和状态指示

## 配置示例

### 完整配置示例

```env
# 多邮箱池配置示例
EMAIL_USER_1=admin@yourcompany.com
EMAIL_PASS_1=abcd efgh ijkl mnop

EMAIL_USER_2=support@yourcompany.com
EMAIL_PASS_2=wxyz abcd efgh ijkl

EMAIL_USER_3=noreply@yourcompany.com
EMAIL_PASS_3=mnop qrst uvwx yzab

# 其他配置
NEXT_PUBLIC_BASE_URL=http://localhost:3000
```

### 最小配置示例

```env
# 单邮箱配置
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-password
```

## 故障排除

### 1. 配置检查

访问配置检查页面：`http://localhost:3000/test-email`

检查项目：
- 邮箱账户数量
- 每个账户的配置状态
- 应用专用密码是否正确

### 2. 常见问题

**问题：所有账户都显示"已禁用"**
- 检查应用专用密码是否正确
- 确认Gmail两步验证已启用
- 查看服务器日志中的错误信息

**问题：邮件发送失败**
- 检查网络连接
- 确认Gmail账户没有被限制
- 查看邮箱池管理页面的状态

**问题：账户达到限制**
- 添加更多邮箱账户
- 等待次日自动重置
- 手动重置账户状态

### 3. 日志查看

在服务器控制台查看详细日志：
```bash
npm run dev
```

关注以下日志信息：
- 邮箱池初始化状态
- 邮件发送成功/失败信息
- 账户轮换和限制信息

## 最佳实践

### 1. 账户管理
- 使用不同的Gmail账户，避免同时达到限制
- 定期检查账户状态和发送计数
- 保持足够的备用账户

### 2. 监控告警
- 定期查看邮箱池管理页面
- 设置使用率告警（80%以上）
- 监控发送失败率

### 3. 安全考虑
- 使用强密码保护Gmail账户
- 定期更换应用专用密码
- 不要将密码提交到版本控制

### 4. 性能优化
- 合理分配邮箱账户
- 避免单个账户过度使用
- 监控系统整体发送性能

## 生产环境部署

### 1. 环境变量
- 确保生产环境正确配置所有邮箱账户
- 使用安全的密码管理工具
- 定期备份配置信息

### 2. 监控
- 设置邮件发送监控
- 配置错误告警
- 定期检查系统状态

### 3. 扩展
- 根据业务需求添加更多邮箱账户
- 考虑使用专业邮件服务（SendGrid、Mailgun）
- 实现邮件发送队列机制

## 联系支持

如果遇到问题，请：

1. 检查配置是否正确
2. 查看服务器日志
3. 访问邮箱池管理页面
4. 提供详细的错误信息
5. 联系技术支持 