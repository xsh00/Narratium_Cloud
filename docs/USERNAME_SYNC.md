# 用户名同步功能说明

## 概述

Narratium 现已支持用户名同步到 MySQL 数据库功能。用户在手机/电脑端设置的用户名现在会自动同步到数据库，确保数据的一致性和持久化。

## 功能特性

### 1. 数据库字段
- 在 `users` 表中新增 `username` 字段
- 字段类型：`VARCHAR(255)`
- 默认值：`'user'`
- 支持用户自定义用户名

### 2. 同步机制
- **已登录用户**：用户名修改后自动同步到数据库
- **未登录用户**：用户名仅保存在本地存储中
- **登录时**：从数据库加载用户名到本地存储
- **注册时**：自动生成默认用户名（基于邮箱前缀）

### 3. API 接口

#### 更新用户信息
```
PUT /api/user/profile
Content-Type: application/json

{
  "userId": "用户ID",
  "username": "新用户名"
}
```

#### 获取用户信息
```
GET /api/user/profile?userId=用户ID
```

### 4. 前端组件更新

#### SettingsDropdown 组件
- 支持用户名编辑和保存
- 自动同步到数据库（已登录用户）
- 错误处理和用户反馈

#### HomeContent 组件
- 主页用户名设置功能
- 与 SettingsDropdown 保持一致的行为

#### AuthContext
- 新增 `updateUsername` 函数
- 登录/注册时自动同步用户名
- 用户信息类型包含 `username` 字段

## 数据库变更

### 表结构更新
```sql
ALTER TABLE users ADD COLUMN username VARCHAR(255) DEFAULT 'user';
```

### 现有数据迁移
- 自动为现有用户设置默认用户名
- 基于邮箱前缀生成用户名
- 迁移脚本：`scripts/migrate-usernames.js`

## 使用流程

### 1. 用户注册
1. 用户输入邮箱和密码
2. 系统自动生成默认用户名（邮箱前缀）
3. 用户名保存到数据库

### 2. 用户登录
1. 验证邮箱和密码
2. 从数据库加载用户信息（包括用户名）
3. 同步用户名到本地存储

### 3. 修改用户名
1. 用户在设置中修改用户名
2. 前端验证用户名格式
3. 调用 API 更新数据库
4. 更新本地存储和用户状态
5. 显示成功反馈

## 错误处理

### 1. 用户名验证
- 不能为空
- 长度限制：最大50个字符
- 自动去除首尾空格

### 2. 网络错误
- API 调用失败时显示错误信息
- 本地存储作为备用方案
- 重试机制

### 3. 数据库错误
- 用户不存在时返回404
- 更新失败时返回500
- 详细的错误日志

## 管理功能

### 1. 数据库管理页面
- 显示所有用户的用户名
- 支持用户删除操作
- 实时刷新数据

### 2. 迁移工具
- 自动检测和添加字段
- 为现有用户设置默认用户名
- 迁移结果验证

## 兼容性

### 1. 向后兼容
- 现有用户数据自动迁移
- 未登录用户仍可使用本地用户名
- 渐进式功能升级

### 2. 数据一致性
- 登录时自动同步用户名
- 多设备数据保持一致
- 数据库作为权威数据源

## 安全考虑

### 1. 数据验证
- 服务器端用户名格式验证
- 防止恶意输入
- SQL 注入防护

### 2. 权限控制
- 只能修改自己的用户名
- 用户ID验证
- API 访问控制

## 性能优化

### 1. 数据库优化
- 用户名字段索引
- 查询优化
- 连接池管理

### 2. 前端优化
- 异步更新操作
- 错误状态管理
- 用户反馈优化

## 故障排除

### 1. 常见问题
- 用户名更新失败：检查网络连接和用户登录状态
- 数据库连接错误：检查数据库配置
- 迁移失败：检查数据库权限

### 2. 调试方法
- 查看浏览器控制台错误
- 检查服务器日志
- 验证数据库连接

## 未来扩展

### 1. 功能增强
- 用户名唯一性检查
- 用户名历史记录
- 批量用户名管理

### 2. 用户体验
- 用户名建议功能
- 实时用户名验证
- 用户名变更通知

## 技术实现

### 1. 数据库层
- MySQL 字段添加
- 数据迁移脚本
- 查询优化

### 2. API 层
- RESTful 接口设计
- 错误处理机制
- 数据验证

### 3. 前端层
- React 状态管理
- 异步操作处理
- 用户界面优化

### 4. 认证层
- 用户上下文更新
- 登录状态管理
- 数据同步机制 