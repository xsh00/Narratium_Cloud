# 编辑历史消息功能

## 功能概述

现在用户可以编辑聊天对话中的历史用户消息。当用户编辑一条消息并发送后，系统会从该消息开始重新生成对话，忽略该消息之后的所有对话内容。**编辑后的对话数据会自动保存到数据库，确保退出后重新进入时保持修改状态。**

## 使用方法

### 1. 编辑消息
- 将鼠标悬停在任意用户消息上
- 点击出现的编辑按钮（铅笔图标）
- 在编辑框中修改消息内容
- 点击"保存"按钮或按 Enter 键保存修改
- 点击"取消"按钮或按 Escape 键取消编辑

### 2. 重新生成对话
- 保存编辑后，系统会自动从编辑的消息开始重新生成对话
- 编辑消息之后的所有对话内容都会被删除
- 系统会基于新的消息内容生成新的回复
- **修改后的对话数据会自动保存到数据库**

## 技术实现

### 前端组件修改

1. **CharacterChatPanel.tsx**
   - 添加了编辑状态管理（`editingMessageId`, `editingContent`）
   - 为用户消息添加了编辑界面
   - 实现了编辑、保存、取消功能
   - 添加了键盘快捷键支持（Enter 保存，Escape 取消）

2. **app/character/page.tsx**
   - 添加了 `handleEditMessage` 函数
   - 实现了消息编辑后的对话重新生成逻辑
   - **添加了数据库持久化存储功能**
   - 保持了当前活动模式（剧情推进、视角设计等）的设置

### 核心功能

1. **消息编辑界面**
   - 悬停显示编辑按钮
   - 编辑模式下显示文本输入框
   - 保存和取消按钮

2. **对话重新生成**
   - 保留编辑消息之前的所有对话
   - 删除编辑消息之后的所有对话
   - 基于新消息内容重新生成回复

3. **数据持久化存储**
   - **删除编辑消息之后的所有数据库节点**
   - **重新生成对话并保存到数据库**
   - **确保退出后重新进入时保持修改状态**

4. **状态保持**
   - 保持当前的活动模式设置
   - 保持用户输入提示
   - 保持流式输出设置

## 数据持久化流程

1. **删除编辑节点**：使用 `deleteDialogueNode` 删除编辑消息节点及其所有子节点
2. **更新前端状态**：更新消息列表，保留编辑消息之前的内容
3. **添加编辑消息**：在前端添加编辑后的用户消息
4. **重新生成对话**：调用 `handleCharacterChatRequest` 重新生成对话
5. **添加助手回复**：在前端添加新生成的助手回复
6. **保存到数据库**：新生成的对话自动保存到 IndexedDB 数据库
7. **持久化存储**：确保修改后的对话数据在页面刷新或重新进入时保持不变

### 技术细节

- **简化删除逻辑**：直接删除编辑消息节点及其所有子节点，避免复杂的递归删除
- **循环引用防护**：在 `deleteNode` 函数中添加 `visited` 集合，防止循环引用导致的栈溢出
- **重新生成机制**：删除后重新调用 `handleCharacterChatRequest`，确保数据一致性
- **前端状态同步**：手动添加编辑后的用户消息和助手回复，确保界面正确显示

## 用户体验

- **直观的编辑界面**：悬停显示编辑按钮，点击进入编辑模式
- **键盘快捷键**：支持 Enter 保存和 Escape 取消
- **实时反馈**：编辑过程中有明确的视觉反馈
- **对话连续性**：编辑后重新生成对话，保持故事连贯性
- **数据持久化**：修改后的对话数据自动保存，退出后重新进入时保持修改状态
- **移动端适配**：在移动设备上编辑按钮始终可见，支持触摸操作

### 移动端特性

- **智能设备检测**：使用JavaScript检测触摸设备，自动适配显示策略
- **触摸设备**：在触摸设备上编辑按钮始终可见
- **桌面设备**：在桌面设备上编辑按钮仅在悬停时可见
- **触摸优化**：添加 `touch-manipulation` 类，优化触摸响应
- **响应式设计**：在不同屏幕尺寸上都有良好的用户体验

#### 设备检测机制

- **触摸设备检测**：使用 `'ontouchstart' in window` 和 `navigator.maxTouchPoints > 0` 检测
- **动态适配**：根据设备类型动态调整编辑按钮的显示策略
- **实时响应**：监听窗口大小变化，实时更新设备类型判断

#### 响应式断点设计

- **sm (640px 以下)**：编辑按钮始终可见
- **md (768px 以下)**：编辑按钮始终可见  
- **lg (1024px 以上)**：编辑按钮仅在悬停时可见
- **xl (1280px 以上)**：编辑按钮仅在悬停时可见

## 注意事项

1. 只能编辑用户消息，不能编辑角色回复
2. 编辑消息时会删除该消息之后的所有对话
3. 编辑过程中会保持当前的活动模式设置
4. 编辑功能在发送消息时不可用
5. **编辑后的对话数据会自动保存到数据库，确保数据持久化** 